syntax = "proto3";
package pain.proto;

message Header {
    uint32 status = 1;
    string message = 2;
}

message UUID {
    uint64 low = 1;
    uint64 high = 2;
}

message Pair {
    string key = 1;
    string value = 2;
}

message Location {
    string uri = 1;
}

enum ChunkState {
    CHUNK_STATE_NONE = 0;
    CHUNK_STATE_INIT = 1;
    CHUNK_STATE_CHECKIN = 2;
    CHUNK_STATE_SEALED = 3;
};

message ReplicaInfo {
    UUID chunk_id = 1;
    uint64 length = 2;
    Location location = 3;
}

enum ChunkType {
    CHUNK_TYPE_NONE = 0;
    CHUNK_TYPE_NORMAL = 1;  // 3 of replicas
    CHUNK_TYPE_EC = 2;
}

message ChunkConfig {
    uint32 replica_count = 1;
    uint32 parity_count = 2;  // only for EC
}

message ChunkInfo {
    UUID uuid = 1;
    uint64 index = 2;   // chunk index
    uint64 offset = 3;  // offset in file
    uint64 length = 4;  // length of chunk
    ChunkState state = 5;
    ChunkType type = 6;
    ChunkConfig config = 7;
    repeated ReplicaInfo replicas = 8;
}

enum FileType {
    FILE_TYPE_NONE = 0;
    FILE_TYPE_FILE = 1;
    FILE_TYPE_DIRECTORY = 2;
}

message FileInfo {
    UUID file_id = 1;
    FileType type = 2;
    uint64 size = 3;
    uint64 atime = 4;
    uint64 mtime = 5;
    uint64 ctime = 6;
    uint32 mode = 7;
    uint32 uid = 8;
    uint32 gid = 9;
    repeated Pair xattrs = 10;
    repeated ChunkInfo chunk_infos = 11;
}

message DirEntry {
    UUID file_id = 1;
    UUID parent_file_id = 2;
    string name = 3;
    FileType type = 4;
}

message DirEntries {
    repeated DirEntry entries = 1;
}

message ManusyaID {
    string ip = 1;
    int32 port = 2;
    UUID uuid = 3;
}

message StorageInfo {
    string cluster_id = 1;
    int64 ctime = 2;
}

message ManusyaRegistration {
    ManusyaID manusya_id = 1;
    StorageInfo storage_info = 2;
}

message ManusyaDescriptor {
    ManusyaID manusya_id = 1;
    StorageInfo storage_info = 2;
    bool is_alive = 3;
    uint64 last_heartbeat_time = 4;
}
